<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!--/*@thymesVar id="site" type="cn.kevinlu98.cloud.freewindcloud.common.Website"*/-->
<head th:replace="common::head"></head>

<body>
<style>
    .i-grid .dropdown-toggle:after {
        content: none;
    }

    .file-more {
        top: 30px;
        z-index: 999;
        right: 30px;
    }
</style>
<div id="loading">
    <div id="loading-center">
    </div>
</div>
<!--/*@thymesVar id="loginUser" type="cn.kevinlu98.cloud.freewindcloud.pojo.User"*/-->
<div class="wrapper" th:with="loginUser=${#authentication.principal.loginUser}">

    <div th:replace="common::sidebar('cloud')"></div>
    <div th:replace="common::navbar"></div>

    <div class="content-page">
        <div class="container-fluid">
            <div th:replace="common::message"></div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="d-flex align-items-center justify-content-between welcome-content mb-3">
                        <h4>我的文件
                            <button class="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-xl"><i
                                    class="fa fa-upload"></i>上传
                            </button>
                            <button class="btn btn-secondary">新建文件夹</button>
                        </h4>
                        <div class="d-flex align-items-center">
                            <div class="list-grid-toggle mr-4" id="replace-btn">
                                <span th:class="${session['mod'] != 'List'?'icon icon-grid i-grid':'icon i-grid'}"
                                      class="icon icon-grid i-grid"><i
                                        class="ri-layout-grid-line font-size-20"></i></span>
                                <span th:class="${session['mod'] != 'List'?'icon icon-grid i-list':'icon i-list'}"
                                      class="icon icon-grid i-list"><i class="ri-list-check font-size-20"></i></span>
                                <span id="current-mod" class="label label-list"
                                      th:text="${session['mod'] != 'List'?'List':'Grid'}">List</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/cloud/}">/</a></li>
                    <li th:class="${state.index==crumbs.size()-1?'breadcrumb-item active':'breadcrumb-item'}"
                        th:each="crumb,state:${crumbs}">
                        <a th:if="${state.index!=crumbs.size()-1}" th:href="@{/cloud/(path=${crumb.path})}"
                           th:text="${crumb.show}"></a>
                        <a th:if="${state.index==crumbs.size()-1}"
                           th:text="${crumb.show}"></a>
                    </li>
                </ol>
            </nav>
            <div th:class="${session['mod'] != 'List'?'icon icon-grid i-grid':'icon i-grid'}"
                 class="icon icon-grid i-grid">
                <div class="row">
                    <div class="col-lg-2 col-md-6 col-sm-6" th:each="file,state:${files}">
                        <div class="card card-block card-stretch card-height">
                            <div class="card-body image-thumb position-relative">
                                <div class="mb-4 text-center p-3 rounded iq-thumb">
                                    <div class="iq-image-overlay"></div>
                                    <a th:if="${file.isDir()}"
                                       th:href="@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                        <img th:src="${file.type.icon}" class="img-fluid" alt="image1">
                                    </a>
                                    <a th:if="${!file.isDir()}" href="javascript:void (0)">
                                        <img th:src="${file.type.icon}" class="img-fluid" alt="image1">
                                    </a>
                                </div>
                                <div class="dropdown position-absolute file-more" style="cursor: pointer">
                                    <span class="dropdown-toggle"
                                          th:id="${'file-grid-opt-'+state.index}"
                                          data-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-more-2-fill"></i>
                                    </span>
                                    <div class="dropdown-menu dropdown-menu-right"
                                         th:attr="aria-labelledby=${'file-grid-opt-'+state.index}" style="">
                                        <a th:if="${!file.dir}" class="dropdown-item" target="_blank"
                                           th:href="@{/cloud/view(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}"><i
                                                class="ri-eye-fill mr-2"></i>打开</a>
                                        <a th:if="${file.dir}" class="dropdown-item"
                                           th:href="@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                            <i class="ri-eye-fill mr-2"></i>打开</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-share-fill mr-2"></i>分享</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-drag-move-fill mr-2"></i>移动</a>
                                        <a th:if="${!file.dir}" class="dropdown-item" th:href="@{/cloud/download(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}"><i
                                                class="ri-file-download-fill mr-2"></i>下载</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-edit-2-fill mr-2"></i>重命名</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-delete-bin-6-fill mr-2"></i>删除</a>
                                    </div>
                                </div>
                                <h6 class="text-center" th:text="${file.name}"></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:class="${session['mod'] != 'List'?'icon icon-grid i-list':'icon i-list'}"
                 class="icon icon-grid i-list">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card card-block card-stretch card-height">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table mb-0 table-borderless tbl-server-info">
                                        <thead>
                                        <tr>
                                            <th scope="col">文件名</th>
                                            <th scope="col">大小</th>
                                            <th scope="col">更新时间</th>
                                            <th scope="col"></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="file,state:${files}" class="list-file" style="cursor: pointer;">
                                            <td class="file-btn"
                                                th:attr="data-url=@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                                <div class="d-flex align-items-center">
                                                    <div class="icon-small rounded mr-3">
                                                        <img th:src="${file.type.icon}" class="avatar-30">
                                                    </div>
                                                    <div th:text="${file.name}"></div>
                                                </div>
                                            </td>
                                            <td th:text="${file.size}"></td>
                                            <td th:text="${#dates.format(file.update, 'yyyy-MM-dd HH:mm')}"></td>
                                            <td>
                                                <div class="dropdown">
                                                    <span class="dropdown-toggle"
                                                          th:id="${'file-list-opt-'+state.index}"
                                                          data-toggle="dropdown" aria-expanded="false">
                                                        <i class="ri-more-fill"></i>
                                                    </span>
                                                    <div class="dropdown-menu dropdown-menu-right"
                                                         th:attr="aria-labelledby=${'file-list-opt-'+state.index}"
                                                         style="">
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-eye-fill mr-2"></i>预览</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-share-fill mr-2"></i>分享</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-drag-move-fill mr-2"></i>移动</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-file-download-fill mr-2"></i>下载</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-edit-2-fill mr-2"></i>重命名</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-delete-bin-6-fill mr-2"></i>删除</a>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade bd-example-modal-xl" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">上传文件</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body">
                    <input type="hidden" id="upload-path" th:value="${uploadPath}">
                    <button type="button" id="upload-files-btn" class="btn btn-primary mt-2"><i class="fa fa-plus"></i>
                        上传文件
                    </button>
                    <input style="display: none" id="upload-files" multiple type="file">
                    <button type="button" id="upload-dir-btn" class="btn btn-primary mt-2"><i class="fa fa-plus"></i>
                        上传文件夹
                    </button>
                    <input style="display: none" id="upload-dir" webkitdirectory type="file">
                    <button type="button" id="start-upload" class="btn btn-success mt-2"><i class="fa fa-upload"></i>
                        开始上传
                    </button>
                </div>
                <div class="card-body">
                    <h5 class="modal-title">总进度</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" id="file-prograss" role="progressbar" aria-valuenow="0"
                             aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="alert text-white bg-primary" role="alert">
                        <div class="iq-alert-text" id="upload-result">上传结果</div>
                    </div>
                    <table id="user-list-table" class="table table-striped table-bordered mt-4 " role="grid"
                           aria-describedby="user-list-page-info">
                        <thead>
                        <tr>
                            <th>文件名</th>
                            <th>大小</th>
                            <th>进度</th>
                        </tr>
                        </thead>
                        <tbody id="file-list-table">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Wrapper End-->
<div th:replace="common::footer"></div>
<div th:include="common::script"></div>
<div th:replace="common::modal"></div>
<script>
    $(function () {
        let uploadFileList = {}
        $('.list-file').hover(
            function () {
                $(this).addClass('bg-primary')
            },
            function () {
                $(this).removeClass('bg-primary')
            }
        )
        $(".file-btn").on('click', function () {
            location.href = $(this).data('url')
        })

        $("#replace-btn").on('click', function () {
            $.get("/cloud/mod?mod=" + $("#current-mod").text());
        })

        $("#upload-files-btn").on('click', function () {
            $("#upload-files").click()
        })
        $("#upload-dir-btn").on('click', function () {
            $("#upload-dir").click()
        })

        function convertSize(limit) {
            var size = "";
            if (limit < 0.1 * 1024) {                            //小于0.1KB，则转化成B
                size = limit.toFixed(2) + "B"
            } else if (limit < 0.1 * 1024 * 1024) {            //小于0.1MB，则转化成KB
                size = (limit / 1024).toFixed(2) + "KB"
            } else if (limit < 0.1 * 1024 * 1024 * 1024) {        //小于0.1GB，则转化成MB
                size = (limit / (1024 * 1024)).toFixed(2) + "MB"
            } else {                                            //其他转化成GB
                size = (limit / (1024 * 1024 * 1024)).toFixed(2) + "GB"
            }

            var sizeStr = size + "";                        //转成字符串
            var index = sizeStr.indexOf(".");                    //获取小数点处的索引
            var dou = sizeStr.substr(index + 1, 2)            //获取小数点后两位的值
            if (dou === "00") {                                //判断后两位是否为00，如果是则删除00
                return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
            }
            return size;
        }

        $("#start-upload").on('click', function () {
            let keys = Object.keys(uploadFileList);
            if (keys.length === 0) {
                layer.msg("未选择上传文件", {icon: 2})
            } else {
                let idx = layer.load()
                let fp = $("#file-prograss")
                let fpall = keys.length;
                let fpsucc = 0;
                let fpfail = 0;
                for (let i = 0; i < keys.length; i++) {
                    let pragress = $(`#file-list-table tr:nth-child(${i + 1}) .progress-bar`)
                    let fileItem = uploadFileList[keys[i]];
                    let total = fileItem.files.length;
                    let success = 0;
                    let breakFlag = false;
                    for (let j = 0; j < fileItem.files.length; j++) {
                        let item = fileItem.files[j];
                        let csrf = $("#spring-csrf");
                        let formData = new FormData();
                        formData.append("file", item);
                        formData.append(csrf.attr("name"), csrf.val())
                        formData.append('path', $("#upload-path").val())
                        $.ajax({
                            url: "/cloud/upload",
                            type: "post",
                            dataType: "json",
                            cache: false,
                            async: false,
                            data: formData,
                            processData: false,// 不处理数据
                            contentType: false, // 不设置内容类型
                            success: res => {
                                if (res.success) {
                                    success++;
                                    pragress.stop().animate({'width': `${(success) * 100 / total}%`})
                                } else {
                                    fpfail++;
                                    layer.msg(res.message, {icon: 2})
                                    breakFlag = true;
                                }
                            }
                        })
                        if (breakFlag) {
                            $(`#file-list-table tr:nth-child(${i + 1})`).css('color', 'red')
                            break
                        }
                    }
                    if (!breakFlag) {
                        fpsucc++;
                    } else {
                        $.get(`/cloud/rollback?target=${fileItem.name}&path=${$("#upload-path").val()}`)
                    }

                    fp.stop().animate({'width': `${(fpsucc) * 100 / fpall}%`})
                }
                $("#upload-result").text(`上传完成，共${fpsucc}成功，${fpfail}失败`)
                layer.close(idx)
            }
        })

        function updateList() {
            let html = "";
            let keys = Object.keys(uploadFileList);
            console.log(keys);
            for (let i = 0; i < keys.length; i++) {
                let fileItem = uploadFileList[keys[i]]
                html += `<tr><td>${fileItem.name}</td><td>${fileItem.size}</td><td><div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                     </div></td></tr>`
            }
            $("#file-list-table").html("")
            $("tbody#file-list-table").html(html)
        }

        $("#upload-files").on('change', function () {
            for (let i = 0; i < this.files.length; i++) {
                let file = this.files[i];
                if (file.name === ".DS_Store") {
                    continue
                }
                let uploadItem = {
                    name: file.webkitRelativePath ? file.webkitRelativePath : file.name,
                    size: convertSize(file.size),
                    files: [file]
                }
                uploadFileList[uploadItem.name] = uploadItem;
            }
            console.log(uploadFileList);
            updateList()
        })

        $("#upload-dir").on('change', function () {
            if (this.files.length > 0) {
                let uploadItem = {
                    name: this.files[0].webkitRelativePath.substring(0, this.files[0].webkitRelativePath.indexOf("/")),
                    files: [],
                    size: ''
                }
                let size = 0;
                for (let i = 0; i < this.files.length; i++) {

                    let file = this.files[i];
                    if (file.name === ".DS_Store") {
                        continue
                    }
                    uploadItem.files.push(file)
                    size += file.size
                }
                uploadItem.size = convertSize(size)
                uploadFileList[uploadItem.name] = uploadItem;
            }
            console.log(uploadFileList);
            updateList()
        })
    })
</script>
</body>
</html>

<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!--/*@thymesVar id="site" type="cn.kevinlu98.cloud.freewindcloud.common.Website"*/-->
<head th:replace="common::head"></head>

<body>
<style>
    .i-grid .dropdown-toggle:after {
        content: none;
    }

    .file-more {
        top: 30px;
        z-index: 999;
        right: 30px;
    }
</style>
<div id="loading">
    <div id="loading-center">
    </div>
</div>
<!--/*@thymesVar id="loginUser" type="cn.kevinlu98.cloud.freewindcloud.pojo.User"*/-->
<div class="wrapper" th:with="loginUser=${#authentication.principal.loginUser}">

    <div th:replace="common::sidebar('cloud')"></div>
    <div th:replace="common::navbar"></div>

    <div class="content-page">
        <div class="container-fluid">
            <div th:replace="common::message"></div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="d-flex align-items-center justify-content-between welcome-content mb-3">
                        <h4>我的文件
                            <button class="btn btn-primary" id="open-upload-btn"><i class="fa fa-upload"></i>上传</button>
                            <button class="btn btn-secondary" id="mkdir-btn">新建文件夹</button>
                        </h4>
                        <div class="d-flex align-items-center">
                            <div class="list-grid-toggle mr-4" id="replace-btn">
                                <span th:class="${session['mod'] != 'List'?'icon icon-grid i-grid':'icon i-grid'}"
                                      class="icon icon-grid i-grid"><i
                                        class="ri-layout-grid-line font-size-20"></i></span>
                                <span th:class="${session['mod'] != 'List'?'icon icon-grid i-list':'icon i-list'}"
                                      class="icon icon-grid i-list"><i class="ri-list-check font-size-20"></i></span>
                                <span id="current-mod" class="label label-list"
                                      th:text="${session['mod'] != 'List'?'List':'Grid'}">List</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/cloud/}">/</a></li>
                    <li th:class="${state.index==crumbs.size()-1?'breadcrumb-item active':'breadcrumb-item'}"
                        th:each="crumb,state:${crumbs}">
                        <a th:if="${state.index!=crumbs.size()-1}" th:href="@{/cloud/(path=${crumb.path})}"
                           th:text="${crumb.show}"></a>
                        <a th:if="${state.index==crumbs.size()-1}"
                           th:text="${crumb.show}"></a>
                    </li>
                </ol>
            </nav>
            <div th:class="${session['mod'] != 'List'?'icon icon-grid i-grid':'icon i-grid'}"
                 class="icon icon-grid i-grid">
                <div class="row">
                    <div class="col-lg-2 col-md-6 col-sm-6" th:each="file,state:${files}">
                        <div class="card card-block card-stretch card-height">
                            <div class="card-body image-thumb position-relative">
                                <div class="mb-4 text-center p-3 rounded iq-thumb">
                                    <div class="iq-image-overlay"></div>
                                    <a th:if="${file.isDir()}"
                                       th:href="@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                        <img th:src="${file.type.icon}" class="img-fluid" alt="image1">
                                    </a>
                                    <a th:if="${!file.isDir()}" href="javascript:void (0)">
                                        <img th:src="${file.type.icon}" class="img-fluid" alt="image1">
                                    </a>
                                </div>
                                <div class="dropdown position-absolute file-more" style="cursor: pointer">
                                    <span class="dropdown-toggle"
                                          th:id="${'file-grid-opt-'+state.index}"
                                          data-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-more-2-fill"></i>
                                    </span>
                                    <div class="dropdown-menu dropdown-menu-right"
                                         th:attr="aria-labelledby=${'file-grid-opt-'+state.index}" style="">
                                        <a th:if="${!file.dir}" class="dropdown-item" target="_blank"
                                           th:href="@{/cloud/view(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}"><i
                                                class="ri-eye-fill mr-2"></i>打开</a>
                                        <a th:if="${file.dir}" class="dropdown-item"
                                           th:href="@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                            <i class="ri-eye-fill mr-2"></i>打开</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-share-fill mr-2"></i>分享</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-drag-move-fill mr-2"></i>移动</a>
                                        <a th:if="${!file.dir}" class="dropdown-item"
                                           th:href="@{/cloud/download(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}"><i
                                                class="ri-file-download-fill mr-2"></i>下载</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-edit-2-fill mr-2"></i>重命名</a>
                                        <a class="dropdown-item" href="#"><i
                                                class="ri-delete-bin-6-fill mr-2"></i>删除</a>
                                    </div>
                                </div>
                                <h6 class="text-center" th:text="${file.name}"></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:class="${session['mod'] != 'List'?'icon icon-grid i-list':'icon i-list'}"
                 class="icon icon-grid i-list">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card card-block card-stretch card-height">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table mb-0 table-borderless tbl-server-info">
                                        <thead>
                                        <tr>
                                            <th scope="col">文件名</th>
                                            <th scope="col">大小</th>
                                            <th scope="col">更新时间</th>
                                            <th scope="col"></th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="file,state:${files}" class="list-file" style="cursor: pointer;">
                                            <td class="file-btn"
                                                th:attr="data-url=@{/cloud/(path=${T(cn.kevinlu98.cloud.freewindcloud.common.DesUtils).encryption(file.absPath)})}">
                                                <div class="d-flex align-items-center">
                                                    <div class="icon-small rounded mr-3">
                                                        <img th:src="${file.type.icon}" class="avatar-30">
                                                    </div>
                                                    <div th:text="${file.name}"></div>
                                                </div>
                                            </td>
                                            <td th:text="${file.size}"></td>
                                            <td th:text="${#dates.format(file.update, 'yyyy-MM-dd HH:mm')}"></td>
                                            <td>
                                                <div class="dropdown">
                                                    <span class="dropdown-toggle"
                                                          th:id="${'file-list-opt-'+state.index}"
                                                          data-toggle="dropdown" aria-expanded="false">
                                                        <i class="ri-more-fill"></i>
                                                    </span>
                                                    <div class="dropdown-menu dropdown-menu-right"
                                                         th:attr="aria-labelledby=${'file-list-opt-'+state.index}"
                                                         style="">
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-eye-fill mr-2"></i>预览</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-share-fill mr-2"></i>分享</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-drag-move-fill mr-2"></i>移动</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-file-download-fill mr-2"></i>下载</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-edit-2-fill mr-2"></i>重命名</a>
                                                        <a class="dropdown-item" href="#"><i
                                                                class="ri-delete-bin-6-fill mr-2"></i>删除</a>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="upload-files-box" style="display: none">
    <input type="file" multiple>
</div>
<div id="upload-dir-box" style="display: none">
    <input type="file" webkitdirectory>
</div>
<!-- Wrapper End-->
<div th:replace="common::footer"></div>
<div th:include="common::script"></div>
<div th:replace="common::modal"></div>
<script id="uplado-window" type="text/html">
    <div style="width: 800px;">
        <div class="dropdown" style="outline: none!important;">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton"
                    data-toggle="dropdown"
                    aria-expanded="false">
                上传文件
            </button>
            <button type="button" class="btn btn-secondary float-right">清空列表</button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="width: 100px;min-width: 0">
                <a class="dropdown-item upload-files-btn" href="javascript:void (0)" style="padding: 5px 10px;">上传文件</a>
                <a class="dropdown-item upload-dir-btn" href="javascript:void (0)"
                   style="padding: 5px 10px;">上传目录</a>
            </div>
        </div>
        <div class="mt-3" id="msg-box">

        </div>
        <div class="row border-bottom mt-3 ml-0 mr-0 shadow-sm">
            <div class="col-md-6 p-3">文件名</div>
            <div class="col-md-3 p-3">文件大小</div>
            <div class="col-md-3 p-3">上传状态</div>
        </div>
        <div class="mb-5" style="height: 400px;overflow-y: scroll" id="file-list-body">

        </div>
    </div>
</script>
<input type="hidden" id="upload-path" th:value="${uploadPath}">
<script th:src="@{/static/js/md5.js}"></script>
<script>
    $(function () {
        let csrf = $("#spring-csrf");

        function sizeTransform(limit) {
            let size = "";
            if (limit < 0.1 * 1024) {                            //小于0.1KB，则转化成B
                size = limit.toFixed(2) + "B"
            } else if (limit < 0.1 * 1024 * 1024) {            //小于0.1MB，则转化成KB
                size = (limit / 1024).toFixed(2) + "KB"
            } else if (limit < 0.1 * 1024 * 1024 * 1024) {        //小于0.1GB，则转化成MB
                size = (limit / (1024 * 1024)).toFixed(2) + "MB"
            } else {                                            //其他转化成GB
                size = (limit / (1024 * 1024 * 1024)).toFixed(2) + "GB"
            }

            let sizeStr = size + "";                        //转成字符串
            let index = sizeStr.indexOf(".");                    //获取小数点处的索引
            let dou = sizeStr.substr(index + 1, 2)            //获取小数点后两位的值
            if (dou === "00") {                                //判断后两位是否为00，如果是则删除00
                return sizeStr.substring(0, index) + sizeStr.substr(index + 3, 2)
            }
            return size;
        }

        $('.list-file').hover(
            function () {
                $(this).addClass('bg-primary')
            },
            function () {
                $(this).removeClass('bg-primary')
            }
        )

        $("#replace-btn").on('click', function () {
            $.get("/cloud/mod?mod=" + $("#current-mod").text());
        })
        let fileList = {};
        $("#open-upload-btn").on('click', function () {
            let idx = layer.open({
                title: "上传文件",
                content: $('#uplado-window').html(),
                btn: ['开始上传', '取消上传'],
                yes: function () {
                    let keys = Object.keys(fileList);
                    for (let i = 0; i < keys.length; i++) {
                        let key = keys[i];
                        if (fileList[key].finish === 0)
                            doUpload(key, keys)
                    }
                },
                btn2: function () {
                    layer.close(idx)
                }
            })
        })
        $("body").on('click', '.upload-files-btn', function () {
            $("#upload-files-box input[type=file]").click();
        }).on('click', '.upload-dir-btn', function () {
            $("#upload-dir-box input[type=file]").click();
        })


        $("#mkdir-btn").on('click', function () {
            layer.prompt({
                title: "请输入文件夹的名称",
            }, function (name) {
                $.ajax({
                    url: '/cloud/mkdir',
                    data: {
                        name: name,
                        path: $("#upload-path").val()
                    },
                    dataType: 'json',
                    success: res => {
                        if (res.success) {
                            layer.msg("创建成功", {icon: 1}, function () {
                                location.reload()
                            })
                        } else {
                            layer.msg("创建失败", {icon: 2})
                        }
                    }
                })
            })
        })

        $("#upload-files-box").on('change', "input[type=file]", function () {
            for (let i = 0; i < this.files.length; i++) {
                let file = this.files[i]
                let key = hex_md5(file.name);
                if (!fileList[key]) {
                    fileList[key] = file;
                    fileList[key]['finish'] = 0;
                }
            }
            $("#upload-files-box").html('<input type="file" multiple>')
            updateList()
        })

        $("#upload-dir-box").on('change', "input[type=file]", function () {
            for (let i = 0; i < this.files.length; i++) {
                let file = this.files[i]
                let key = hex_md5(file.name);
                if (!fileList[key]) {
                    fileList[key] = file;
                    fileList[key]['finish'] = 0;
                }
            }
            $("#upload-dir-box").html('<input type="file" webkitdirectory>')
            updateList()
        })

        function updateList() {
            let fileTable = $("#file-list-body")
            fileTable.html("")
            let keys = Object.keys(fileList);
            for (let i = 0; i < keys.length; i++) {
                let key = keys[i]
                let file = fileList[key];
                fileTable.append(`
                <div class="row border-bottom ml-0 mr-0 position-relative text-secondary">
                <div id="progress-${key}" class="position-absolute h-100 ${file.fail ? 'bg-danger' : 'bg-success'}" style="opacity: .1;width: ${file.finish + '%'}"></div>
                <div class="col-md-6 p-3">${file.name}</div>
                <div class="col-md-3 p-3">${sizeTransform(file.size)}</div>
                <div id="number-${key}" class="col-md-3 p-3">${file.finish === 0 ? '<a href="javascript:void(0)" class="upload-item-file" data-file="' + key + '">等待上传</a>' : file.finish + "%"}</div>
            </div>`);
            }
        }

        function doUpload(key, keys) {
            if (fileList[key].finish === 0) {
                let xhr = new XMLHttpRequest();
                let fd = new FormData();
                fd.append(csrf.attr("name"), csrf.val())
                fd.append('path', $("#upload-path").val())
                fd.append("file", fileList[key]);
                xhr.open("POST", "/cloud/upload", true);// 上传目标
                xhr.upload.addEventListener("progress", function (evt) {
                    uploadProgress(evt, key)
                }, false);
                xhr.send(fd);
                xhr.onloadend = function () {
                    let res = JSON.parse(xhr.responseText)
                    if (!res.success) {
                        fileList[key]['fail'] = true;
                        $(`#progress-${key}`).removeClass("bg-success").addClass("bg-danger")
                    }
                    fileList[key].finish = 100;
                    let finish = true;
                    let fail = 0;
                    for (let i = 0; i < keys.length; i++) {
                        console.log(fileList[keys[i]]);
                        if (fileList[keys[i]].fail) {
                            fail++;
                        }
                        if (fileList[keys[i]].finish < 100) {
                            finish = false;
                            break;
                        }
                    }
                    console.log(fail);
                    if (finish) {
                        if (fail > 0) {
                            $("#msg-box").html(`<div class="alert text-white bg-danger" role="alert"><div class="iq-alert-text">共<b>${keys.length}</b>个文件上传完成,有<b>${fail}</b>个失败 </div><button type="button" class="close" data-dismiss="alert" aria-label="Close">
                           <i class="ri-close-line"></i>
                           </button></div>`)
                        } else {
                            $("#msg-box").html(`<div class="alert text-white bg-success" role="alert"><div class="iq-alert-text">共<b>${keys.length}</b>个文件上传完成 </div><button type="button" class="close" data-dismiss="alert" aria-label="Close">
                           <i class="ri-close-line"></i>
                           </button></div>`)
                        }
                    }
                }
            }
        }

        function uploadProgress(evt, key) {
            if (evt.lengthComputable) {
                let percentComplete = Math.round((evt.loaded) * 100 / evt.total);
                $(`#progress-${key}`).width(percentComplete + "%");
                $(`#number-${key}`).html(percentComplete + "%")
                fileList[key].finish = percentComplete;
            }
        }

        $(".file-btn").on('click', function () {
            location.href = $(this).data('url')
        })
    })
</script>
</body>
</html>
